import*as THREE from"https://unpkg.com/three@0.126.1/build/three.module.js";import{OrbitControls}from"https://unpkg.com/three@0.126.1/examples/jsm/controls/OrbitControls.js";import{atlanta,beijing,cape,delhi,easter,florence,goiania,hobart,irkutsk,jakarta,kiev}from"./coordinates.js";let scene,camera,controls,renderer,stars,sphere,frame=0;const gui=new dat.GUI,world={wireframe:!0,globe:!0,stars:!0};var top=gui.addFolder("Basic Config"),starsGUI=top.add(world,"stars").name("Show Stars").listen();starsGUI.onChange(function(e){e?scene.add(stars):scene.remove(stars)});var globeGUI=top.add(world,"globe").name("Show Globe").listen();function init(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,1,1400),scene.add(camera),camera.position.set(0,30,90),camera.lookAt(scene.position),camera.updateProjectionMatrix(),(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(innerWidth,innerHeight),renderer.setPixelRatio(window.devicePixelRatio),document.body.appendChild(renderer.domElement),THREEx.WindowResize(renderer,camera),(controls=new OrbitControls(camera,renderer.domElement)).enablePan=!1,controls.enableDamping=!0,controls.dampingFactor=.075,controls.minDistance=50,controls.maxDistance=200,controls.rotateSpeed=.5}function createGlobe(){(sphere=new THREE.Mesh(new THREE.SphereBufferGeometry(30,50,50),new THREE.MeshBasicMaterial({map:(new THREE.TextureLoader).load("./img/globe1.jpg")}))).position.set(0,0,0),scene.add(sphere);const e=new THREE.Mesh(new THREE.SphereBufferGeometry(30,50,30),new THREE.MeshBasicMaterial({color:12303291,wireframe:!0,transparent:!0,opacity:.15}));e.position.set(0,0,0),scene.add(e)}function genStars(){const e=new THREE.BufferGeometry,t=new THREE.PointsMaterial({color:16777215}),r=[];for(let e=0;e<5e4;e++){const e=1e3*(Math.random()-.5),t=1e3*(Math.random()-.5),a=1e3*(Math.random()-.5);e*e+t*t+a*a>12e4&&r.push(e,t,a)}e.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),stars=new THREE.Points(e,t),scene.add(stars)}function rotateStars(){stars.rotation.x+=1e-4,stars.rotation.y+=1e-4}globeGUI.onChange(function(e){e?scene.add(sphere):scene.remove(sphere)}),top.open(),init(),createGlobe(),genStars();let cities=[],rayCities=[];function generateCity(e,t){const r=new THREE.Mesh(new THREE.SphereBufferGeometry(.25,21,21),new THREE.MeshBasicMaterial({color:"#ff0000"}));r.name=e,r.position.set(t.x,t.y,t.z),cities.push(r),rayCities.push(r),r.add(generateLabel(r))}function makeTextSprite(e,t){void 0===t&&(t={});var r=t.hasOwnProperty("fontface")?t.fontface:"Arial",a=t.hasOwnProperty("fontsize")?t.fontsize:18,n=t.hasOwnProperty("borderThickness")?t.borderThickness:4,o=t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},i=t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:1},s=document.createElement("canvas"),c=s.getContext("2d");c.font="Bold "+a+"px "+r;var l=c.measureText(e).width;c.fillStyle="rgba("+i.r+","+i.g+","+i.b+","+i.a+")",c.strokeStyle="rgba("+o.r+","+o.g+","+o.b+","+o.a+")",c.lineWidth=n,roundRect(c,n/2+50,n/2,l+n,1.2*a+n,19),c.fillStyle="rgba(0, 0, 0, 1.0)",c.fillText(e,n+50,a+n);var d=new THREE.Texture(s);d.needsUpdate=!0;var h=new THREE.SpriteMaterial({map:d}),u=new THREE.Sprite(h);return u.scale.set(5,2,6),h.depthTest=!1,u}function roundRect(e,t,r,a,n,o){e.beginPath(),e.moveTo(t+o,r),e.lineTo(t+a-o,r),e.quadraticCurveTo(t+a,r,t+a,r+o),e.lineTo(t+a,r+n-o),e.quadraticCurveTo(t+a,r+n,t+a-o,r+n),e.lineTo(t+o,r+n),e.quadraticCurveTo(t,r+n,t,r+n-o),e.lineTo(t,r+o),e.quadraticCurveTo(t,r,t+o,r),e.closePath(),e.fill(),e.stroke()}function generateLabel(e){return makeTextSprite(e.name,{fontsize:80,borderColor:{r:225,g:0,b:0,a:1},backgroundColor:{r:225,g:140,b:0,a:.9}})}function convertCoordsRad(e,t){var r=e*(Math.PI/180),a=-t*(Math.PI/180);return{x:Math.cos(r)*Math.cos(a)*30,y:30*Math.sin(r),z:Math.cos(r)*Math.sin(a)*30}}function convertPolarToAng(e){return{lat:Math.asin(e.y/30)*(180/Math.PI),lon:-1*Math.atan2(e.z,e.x)*(180/Math.PI)}}function sca(){return 12*Math.random()-6}const EarthR=6371e3;function haversine(){var e=convertPolarToAng(cities[dragIdx].position);document.getElementById("loc").innerHTML="lat:"+(Math.round(100*e.lat)/100).toString()+" lon:"+(Math.round(100*e.lon)/100).toString();for(var t=0;t<cities.length;t++){var r=convertPolarToAng(cities[t].position),a=e.lat*Math.PI/180,n=r.lat*Math.PI/180,o=(r.lat-e.lat)*Math.PI/180,i=(r.lon-e.lon)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(a)*Math.cos(n)*Math.sin(i/2)*Math.sin(i/2),c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),l=EarthR*c;document.getElementById(t.toString()).innerHTML=cities[dragIdx].name+"->"+cities[t].name+":"+(Math.round(l/10)/100).toString()+"km",currDistance[dragIdx][t]=l}console.log(currDistance)}function changeColors(){let e=truePosition[dragIdx],t=convertPolarToAng(cities[dragIdx].position);Math.sqrt((e.lat-t.lat)**2+(e.lon-t.lon)**2)<.8?(cities[dragIdx].material.color.setHex(43784),cities[dragIdx].children[0].material.color.setHex(5898063)):(cities[dragIdx].material.color.setHex(16711680),cities[dragIdx].children[0].material.color.setHex(16777215))}let truePosition=[atlanta,beijing,cape,delhi,easter,florence,goiania,hobart];for(let e=0;e<truePosition.length;e++)generateCity(String.fromCharCode(65+e),convertCoordsRad(truePosition[e].lat+sca(),truePosition[e].lon+sca()));for(let e=0;e<cities.length;e++)scene.add(cities[e]);let trueDistance=[];for(let e=0;e<truePosition.length;e++){trueDistance.push([]);for(let t=0;t<truePosition.length;t++){var φ1=truePosition[e].lat*Math.PI/180,φ2=truePosition[t].lat*Math.PI/180,Δφ=(truePosition[t].lat-truePosition[e].lat)*Math.PI/180,Δλ=(truePosition[t].lon-truePosition[e].lon)*Math.PI/180,a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=EarthR*c;trueDistance[e].push(d)}}let currDistance=[];for(let e=0;e<cities.length;e++){var home=convertPolarToAng(cities[e].position);currDistance.push([]);for(let t=0;t<cities.length;t++){var away=convertPolarToAng(cities[t].position);φ1=home.lat*Math.PI/180,φ2=away.lat*Math.PI/180,Δφ=(away.lat-home.lat)*Math.PI/180,Δλ=(away.lon-home.lon)*Math.PI/180,a=Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=EarthR*c;currDistance[e].push(d)}}let deltaDistances=[];for(let e=0;e<cities.length;e++);let base=new THREE.Vector3,dest=new THREE.Vector3,points=[],mid=new THREE.Vector3,curve_meshes=[];function drawCurves(){clearCurves(),curve_meshes=[],base.set(cities[dragIdx].position.x,cities[dragIdx].position.y,cities[dragIdx].position.z);for(let e=0;e<cities.length;e++)if(e!=dragIdx){dest.set(cities[e].position.x,cities[e].position.y,cities[e].position.z),points=[],mid.addVectors(dest,base),mid.multiplyScalar(.5),mid.normalize(),mid.multiplyScalar(30);for(let e=0;e<=12;e++){let t=(new THREE.Vector3).lerpVectors(base,mid,e/12);t.multiplyScalar(.5),t.normalize(),t.multiplyScalar(30),points.push(t)}for(let e=0;e<=12;e++){let t=(new THREE.Vector3).lerpVectors(mid,dest,e/12);t.multiplyScalar(.5),t.normalize(),t.multiplyScalar(30),points.push(t)}curve_meshes.push(new THREE.Mesh(new THREE.TubeBufferGeometry(new THREE.CatmullRomCurve3(points),64,.05,50,!1),new THREE.MeshBasicMaterial({color:16745472})))}for(let e=0;e<curve_meshes.length;e++)scene.add(curve_meshes[e])}function clearCurves(){for(let e=0;e<curve_meshes.length;e++)scene.remove(curve_meshes[e]),curve_meshes[e].material.dispose(),curve_meshes[e].geometry.dispose()}var raycaster=new THREE.Raycaster;raycaster.near=1,raycaster.far=200;var dragIdx,mouse=new THREE.Vector2,raySphere=new THREE.Sphere(new THREE.Vector3(0,0,0),30),raySphereIntersect=new THREE.Vector3,shift=new THREE.Vector3,isDragging=!1;function animate(){controls.update(),frame=(frame+1)%1,rotateStars(),requestAnimationFrame(animate),renderer.render(scene,camera)}rayCities.push(sphere),document.addEventListener("pointermove",e=>{mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1,isDragging&&(raycaster.setFromCamera(mouse,camera),raycaster.ray.intersectSphere(raySphere,raySphereIntersect),cities[dragIdx].position.addVectors(raySphereIntersect,shift),changeColors(),haversine(),drawCurves())}),document.addEventListener("pointerdown",()=>{raycaster.setFromCamera(mouse,camera);var e=raycaster.intersectObjects(rayCities);if(!(e.length>0&&e[0].object==sphere)&&(raycaster.ray.intersectSphere(raySphere,raySphereIntersect),e.length>0)){controls.enabled=!1,isDragging=!0;for(let t=0;t<cities.length;t++)if(cities[t]==e[0].object){dragIdx=t;break}drawCurves()}}),document.addEventListener("pointerup",()=>{isDragging=!1,dragIdx=null,controls.enabled=!0,clearCurves()}),animate();